<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ورود — Eclipse Hunter</title>
  <style>
    :root {
      --tg-blue:#0088cc;
      --bg:#f6f9fc;
      --card:#ffffff;
      --muted:#6b7280;
      --danger:#b91c1c;
      --success:#059669;
    }
    * { box-sizing:border-box; font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial }
    html,body { height:100%; margin:0; background:linear-gradient(180deg,#eaf6fb 0%,var(--bg) 100%); color:#111 }
    .wrap { min-height:100vh; display:flex; align-items:center; justify-content:center; padding:20px }
    .card { width:100%; max-width:460px; background:var(--card); border-radius:16px; box-shadow:0 8px 30px rgba(2,6,23,0.06); padding:20px }
    h1 { margin:0 0 8px; font-size:20px; color:var(--tg-blue); text-align:center }
    p.lead { margin:0 0 16px; text-align:center; color:var(--muted); font-size:14px }
    form { display:flex; flex-direction:column; gap:10px }
    .input { width:100%; padding:12px 14px; border-radius:12px; border:1px solid #e6eef6; background:transparent; font-size:15px; direction:ltr }
    .btn { display:inline-flex; align-items:center; justify-content:center; padding:12px; border-radius:12px; border:0; background:var(--tg-blue); color:#fff; font-weight:600; cursor:pointer; font-size:15px }
    .muted { color:var(--muted); font-size:13px; text-align:center }
    .links { display:flex; justify-content:center; margin-top:10px; gap:8px }
    .msg { margin-top:10px; text-align:center; font-size:13px; color:var(--danger); min-height:20px }
    .row { display:flex; gap:8px; align-items:center; justify-content:space-between }
    label.checkbox { font-size:13px; color:var(--muted); display:flex; align-items:center; gap:8px; cursor:pointer }
    .small { font-size:13px; color:var(--muted) }
    @media(min-width:720px) {
      .card { padding:28px }
      h1 { font-size:22px }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" role="main" aria-labelledby="title">
      <h1 id="title">ورود به Eclipse Hunter</h1>
      <p class="lead">با نام کاربری و رمز عبور خود وارد شوید</p>

      <form id="loginForm" autocomplete="off" novalidate>
        <input id="username" name="username" class="input" type="text" placeholder="Username (آیدی)" required />
        <input id="password" name="password" class="input" type="password" placeholder="Password (رمز عبور)" required />

        <div class="row" style="align-items:center;flex-wrap:wrap">
          <label class="checkbox"><input id="remember" type="checkbox" /> مرا به خاطر بسپار</label>
          <a href="/forgot.html" class="small" style="color:var(--tg-blue);text-decoration:none">رمز را فراموش کرده‌اید؟</a>
        </div>

        <button type="submit" class="btn">ورود</button>
      </form>

      <div class="links muted" style="margin-top:12px">
        <span>حساب ندارید؟</span>
        <a href="/register.html" style="color:var(--tg-blue);text-decoration:none;font-weight:600;margin-left:6px">ثبت‌ نام</a>
      </div>

      <div id="message" class="msg" aria-live="polite"></div>
    </div>
  </div>

  <script>
    (function(){
      const form = document.getElementById('loginForm');
      const msg = document.getElementById('message');

      // ✅ اگر قبلاً وارد شده باشد، مستقیم برو به چت
      const existingToken = localStorage.getItem('token') || sessionStorage.getItem('token');
      if (existingToken) {
        window.location.href = '/chat.html';
        return;
      }

      function showMessage(text, ok) {
        msg.textContent = text || '';
        msg.style.color = ok
          ? getComputedStyle(document.documentElement).getPropertyValue('--success')
          : getComputedStyle(document.documentElement).getPropertyValue('--danger');
      }

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        showMessage('', false);

        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value;
        const remember = document.getElementById('remember').checked;

        if (!username || !password) {
          showMessage('لطفاً همه‌ی فیلدهای مورد نیاز را پر کنید', false);
          return;
        }

        try {
          const res = await fetch('/auth/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password })
          });

          // parse JSON safely
          let data = null;
          try { data = await res.json(); } catch (err) { data = null; }

          if (res.ok && data && data.ok && data.token) {
            showMessage('ورود موفق — در حال انتقال...', true);

            try {
              if (remember) localStorage.setItem('token', data.token);
              else sessionStorage.setItem('token', data.token);
            } catch (e) {}

            setTimeout(() => {
              location.href = '/chat.html';
            }, 650);
            return;
          }

          // handle known server-side errors gracefully
          if (data && data.error) {
            let txt = data.error;
            if (data.error === 'user_not_found' || data.error === 'user_not_found') txt = 'کاربری با این نام یافت نشد';
            if (data.error === 'wrong_password' || data.error === 'invalid_credentials') txt = 'نام‌کاربری یا رمز عبور اشتباه است';
            if (data.error === 'missing_fields') txt = 'فیلدها تکمیل نشده‌اند';
            showMessage(txt, false);
            return;
          }

          // fallback: non-JSON or unexpected server response
          if (!res.ok) {
            showMessage('خطا در ورود — سرور پاسخ ناموفق داد', false);
          } else {
            showMessage('خطا در ورود', false);
          }
        } catch (err) {
          console.error('Login fetch error', err);
          showMessage('خطا در اتصال به سرور', false);
        }
      });
    })();
  </script>
</body>
</html>